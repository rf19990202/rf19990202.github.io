<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Intro</title>
    <style>
      #console {
        display: none;
      }
      * {
        margin: 0;
        padding: 0;
        position: relative;
        overscroll-behavior: none;
      }

      html {
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      body {
        height: 100%;
        word-wrap: break-word;
        overflow: hidden;
        text-align: center;

        & > :nth-child(1) {
          display: flex;
          flex-direction: column;
          top: 8vh;
          height: 60dvh;
          align-items: center;

          &::before {
            position: absolute;
            width: 100%;
            height: 100%;
            content: "";
            background-color: rgba(128, 128, 128, 0.4);
            filter: blur(2px);
          }
        }
      }
      #weather {
        position: fixed;
        box-sizing: content-box;
        width: 90%;
        height: 50%;
        border: 1px solid grey;
        margin: 2rem;
        border-radius: 5px;
        overflow: hidden;
        /* background: rgb(0, 17, 255); */
        background-repeat: repeat;
        animation: sky-color 2s linear;
        & > div#weather-info {
          text-align: left;
          text-shadow: 1px 1px 2px pink;
        }
      }
      #sunny {
        display: none;
        position: absolute;
        bottom: 9dvh;
        right: 0;
        width: 30dvh;
        & > div:nth-child(1) {
          position: absolute;
          left: 10dvh;
          top: 10dvh;
          width: 10dvh;
          height: 10dvh;
          background-color: rgb(250, 250, 0);
          border-radius: 50%;
        }
        & > div:nth-child(2) {
          position: absolute;
          left: 10dvh;
          top: 10dvh;
          width: 10dvh;
          height: 10dvh;
          background-color: rgb(125, 125, 0);
          border-radius: 50%;
          animation: sunshine 2s linear infinite;
          z-index: -1;
        }
        & > div:nth-child(3) {
          position: absolute;
          left: 10dvh;
          top: 10dvh;
          width: 10dvh;
          height: 10dvh;
          background-color: rgb(255, 125, 0);
          border-radius: 50%;
          animation: sunshine 2s linear infinite;
          animation-delay: 1s;
          z-index: -1;
        }
      }
      @keyframes sunshine {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        100% {
          transform: scale(1.5);
          opacity: 0;
        }
      }
      @keyframes sunup {
        0% {
          height: 0;
          opacity: 0;
        }
        100% {
          height: 30dvh;
          opacity: 1;
        }
      }
      #cloudy {
        display: none;
        position: absolute;
        right: 0;
        top: 0;
        width: 80%;
        height: 30%;
        overflow: hidden;
        & > div:nth-child(1) {
          position: absolute;
          width: 7.5rem;
          height: 7.5rem;
          overflow: hidden;
          & > div:nth-child(1) {
            position: absolute;
            inset: -40% auto auto -20%;
            width: 70%;
            height: 70%;
            background-color: white;
            border-radius: 50%;
          }
          & > div:nth-child(2) {
            position: absolute;
            inset: -30% auto auto 40%;
            width: 50%;
            height: 50%;
            background-color: white;
            border-radius: 50%;
          }
        }
        & > div:nth-child(2) {
          position: absolute;
          right: 0;
          width: 9rem;
          height: 9rem;
          overflow: hidden;
          & > div:nth-child(1) {
            position: absolute;
            inset: -20% -20% auto auto;
            width: 65%;
            height: 65%;
            background-color: white;
            border-radius: 50%;
          }
          & > div:nth-child(2) {
            position: absolute;
            inset: -10% 30% auto auto;
            width: 40%;
            height: 40%;
            background-color: white;
            border-radius: 50%;
          }
          & > div:nth-child(3) {
            position: absolute;
            inset: -10% 65% auto auto;
            width: 25%;
            height: 25%;
            background-color: white;
            border-radius: 50%;
          }
        }
      }
      #rainy {
        display: none;
      }
    </style>
  </head>

  <body>
    <div>
      <div id="weather">
        <div id="weather-info"></div>
        <div id="sunny">
          <div></div>
          <div></div>
          <div></div>
        </div>
        <div id="cloudy">
          <div>
            <div></div>
            <div></div>
          </div>
          <div>
            <div></div>
            <div></div>
            <div></div>
          </div>
        </div>
        <div id="rainy">
          <div></div>
          <div></div>
          <div></div>
        </div>
      </div>
    </div>
    <div id="console"></div>
    <script defer>
      let BASE_URL = "https://phrasal-clover-408902.de.r.appspot.com";
      (async () => {
        function getLocation() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              getLocationCallbacks.onSuccess,
              getLocationCallbacks.onError
            );
          } else {
            document.getElementById("weather").innerHTML =
              "Geolocation is not supported";
          }
        }
        const getLocationCallbacks = {
          onSuccess: async function (p) {
            const station = await fetch(
              `${BASE_URL}/currentstation?latitude=${
                Math.round(p.coords.latitude * 1000000) / 1000000
              }&longitude=${
                Math.round(p.coords.longitude * 1000000) / 1000000
              }&time=${new Date().now}`
            ).then((ret) => ret.json());
            handleGetWeather(station.StationId);
          },
          onError: function () {},
        };
        getLocation();
      })();
      async function handleGetWeather(stationId) {
        await fetch(`${BASE_URL}/weather?stationId=${stationId}`)
          .then((ret) => ret.json())
          .then((ret) => {
            document.getElementById("weather-info").innerHTML = `
            <p>${ret.time}</p>
            <p>${ret.countyName}</p>
            <p>${ret.stationName}</p>
            <p>${ret.temperature}°C</p>
            <p>${ret.relativeHumidity}%</p>
            <p>precipitation:${ret.precipitation}%</p>`;
            switch (ret.weather) {
              case "陰有雷":
                return "cloudy";
              default:
                return "sunny";
            }
          })
          .then(() => {
            // TODO different weather animations
            // weather should come from api
            let weather = "cloudy";
            weatherBackgroundAnimation[weather]();
          })
          .then(() => {});
      }
      const weatherBackgroundAnimation = {
        sunny: async function () {
          document.getElementById("weather").animate(
            [
              {
                backgroundColor: "#35374B",
              },
              {
                backgroundColor: "skyblue",
              },
            ],
            {
              duration: 1000,
            }
          );
          document.getElementById("sunny").style.display = "block";
          document.getElementById("sunny").animate(
            [
              {
                height: "0",
                opacity: "0",
              },
              {
                height: "30dvh",
                opacity: "1",
              },
            ],
            {
              duration: 1000,
            }
          );
          document.getElementById("weather").style.backgroundColor = "skyblue";
          document.getElementById("sunny").style.height = "30dvh";
        },
        cloudy: async function () {
          document.getElementById("weather").animate(
            [
              {
                backgroundColor: "#35374B",
              },
              {
                backgroundColor: "#ACC2D9",
              },
            ],
            {
              duration: 1000,
            }
          );
          document.getElementById("cloudy").style.display = "block";
          document.getElementById("weather").style.backgroundColor = "#ACC2D9";
        },
        rainy: async function () {
          document.getElementById("weather").animate(
            [
              {
                backgroundColor: "#35374B",
              },
              {
                backgroundColor: "#6D7178",
              },
            ],
            {
              duration: 1000,
            }
          );
          document.getElementById("rainy").style.display = "block";
          document.getElementById("weather").style.backgroundColor = "#6D7178";
        },
      };
    </script>
  </body>
</html>
