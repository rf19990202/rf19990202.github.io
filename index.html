<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Intro</title>
    <style>
      html {
        position: relative;
        width: 360px;
        height: 480px;
        overflow: hidden;
        margin-left: auto;
        margin-right: auto;
      }

      body {
        position: absolute;
        height: 100%;
        word-wrap: break-word;
        overflow: hidden;
        text-align: center;
        width: 360px;
        margin-left: auto;
        margin-right: auto;
      }
      #weather {
        position: absolute;
        box-sizing: border-box;
        top: 0;
        width: 80%;
        height: 80%;
        border: 1px solid grey;
        margin: 2rem;
        border-radius: 5px;
        overflow: hidden;
        background-repeat: repeat;
        animation: sky-color 2s linear;
        & > div#weather-info {
          position: absolute;
          padding: 0.3rem;
          text-align: left;
          text-shadow: 1px 1px 2px pink;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          z-index: 1;
          & > p {
            margin: 0;
          }
        }
      }
      #sunny {
        display: none;
        position: absolute;
        bottom: 9dvh;
        right: 0;
        width: 30dvh;
        & > div:nth-child(1) {
          position: absolute;
          left: 10dvh;
          top: 10dvh;
          width: 10dvh;
          height: 10dvh;
          background-color: rgb(250, 250, 0);
          border-radius: 50%;
          z-index: 1;
        }
        & > div:nth-child(2) {
          position: absolute;
          left: 10dvh;
          top: 10dvh;
          width: 10dvh;
          height: 10dvh;
          background-color: rgb(125, 125, 0);
          border-radius: 50%;
          animation: sunshine 2s linear infinite;
        }
        & > div:nth-child(3) {
          position: absolute;
          left: 10dvh;
          top: 10dvh;
          width: 10dvh;
          height: 10dvh;
          background-color: rgb(255, 125, 0);
          border-radius: 50%;
          animation: sunshine 2s linear infinite;
          animation-delay: 1s;
        }
      }
      @keyframes sunshine {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        100% {
          transform: scale(1.5);
          opacity: 0;
        }
      }
      @keyframes sunup {
        0% {
          height: 0;
          opacity: 0;
        }
        100% {
          height: 30dvh;
          opacity: 1;
        }
      }
      #cloudy {
        display: none;
        position: absolute;
        right: 0;
        top: 0;
        width: 100%;
        height: 30%;
        overflow: hidden;
        & > div:nth-child(1) {
          position: absolute;
          width: 7.5rem;
          height: 7.5rem;
          overflow: hidden;
          & > div:nth-child(1) {
            position: absolute;
            inset: -40% auto auto -20%;
            width: 70%;
            height: 70%;
            background-color: white;
            border-radius: 50%;
          }
          & > div:nth-child(2) {
            position: absolute;
            inset: -30% auto auto 40%;
            width: 50%;
            height: 50%;
            background-color: white;
            border-radius: 50%;
          }
        }
        & > div:nth-child(2) {
          position: absolute;
          right: 0;
          width: 9rem;
          height: 9rem;
          overflow: hidden;
          & > div:nth-child(1) {
            position: absolute;
            inset: -20% -20% auto auto;
            width: 65%;
            height: 65%;
            background-color: white;
            border-radius: 50%;
          }
          & > div:nth-child(2) {
            position: absolute;
            inset: -10% 30% auto auto;
            width: 40%;
            height: 40%;
            background-color: white;
            border-radius: 50%;
          }
          & > div:nth-child(3) {
            position: absolute;
            inset: -10% 65% auto auto;
            width: 25%;
            height: 25%;
            background-color: white;
            border-radius: 50%;
          }
        }
      }
      #rainy {
        display: none;
        position: absolute;
        right: 0;
        top: 0;
        width: 100%;
        height: 30%;
        overflow: hidden;
        & > div:nth-child(1) {
          position: absolute;
          width: 7.5rem;
          height: 7.5rem;
          overflow: hidden;
          & > div:nth-child(1) {
            position: absolute;
            inset: -40% auto auto -20%;
            width: 70%;
            height: 70%;
            background-color: white;
            border-radius: 50%;
          }
          & > div:nth-child(2) {
            position: absolute;
            inset: -30% auto auto 40%;
            width: 50%;
            height: 50%;
            background-color: white;
            border-radius: 50%;
          }
        }
        & > div:nth-child(2) {
          position: absolute;
          right: 0;
          width: 9rem;
          height: 9rem;
          overflow: hidden;
          & > div:nth-child(1) {
            position: absolute;
            inset: -20% -20% auto auto;
            width: 65%;
            height: 65%;
            background-color: white;
            border-radius: 50%;
          }
          & > div:nth-child(2) {
            position: absolute;
            inset: -10% 30% auto auto;
            width: 40%;
            height: 40%;
            background-color: white;
            border-radius: 50%;
          }
          & > div:nth-child(3) {
            position: absolute;
            inset: -10% 65% auto auto;
            width: 25%;
            height: 25%;
            background-color: white;
            border-radius: 50%;
          }
        }
        & > div:nth-child(3) {
          height: 200%;
          overflow: hidden;
        }
      }
      #precipitation {
        border: 1px solid grey;
        border-radius: 1rem;
        padding: 0.3rem;
        width: 3rem;
        align-items: center;
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        & > p {
          margin: 0;
        }
      }
    </style>
  </head>

  <body>
    <div id="weather">
      <div id="weather-info"></div>
      <div id="sunny">
        <div></div>
        <div></div>
        <div></div>
      </div>
      <div id="cloudy">
        <div>
          <div></div>
          <div></div>
        </div>
        <div>
          <div></div>
          <div></div>
          <div></div>
        </div>
      </div>
      <div id="rainy">
        <div>
          <div></div>
          <div></div>
        </div>
        <div>
          <div></div>
          <div></div>
          <div></div>
        </div>
        <div></div>
      </div>
    </div>
    <script defer>
      let BASE_URL = "https://phrasal-clover-408902.de.r.appspot.com";
      (async () => {
        function getLocation() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              getLocationCallbacks.onSuccess,
              getLocationCallbacks.onError
            );
          } else {
            document.getElementById("weather").innerHTML =
              "Geolocation is not supported";
          }
        }
        const getLocationCallbacks = {
          onSuccess: async function (p) {
            const station = await fetch(
              `${BASE_URL}/currentstation?latitude=${
                Math.round(p.coords.latitude * 1000000) / 1000000
              }&longitude=${
                Math.round(p.coords.longitude * 1000000) / 1000000
              }&time=${new Date().now}`
            ).then((ret) => ret.json());
            handleGetWeather(station.StationId);
          },
          onError: function () {},
        };
        getLocation();
      })();
      async function handleGetWeather(stationId) {
        await fetch(`${BASE_URL}/weather?stationId=${stationId}`)
          .then((ret) => ret.json())
          .then((ret) => {
            document.getElementById("weather-info").innerHTML = `
            <p>${ret.time}</p>
            <p>${ret.countyName}</p>
            <p>${ret.stationName}</p>
            <p>${ret.temperature}°C</p>
            <p>${ret.relativeHumidity}%</p>
            <div id="precipitation">
            <svg height="32px" width="32px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 511.984 511.984" xml:space="preserve" fill="#000000"><g stroke-width="0"></g><g stroke-linecap="round" stroke-linejoin="round"></g><g> <path style="fill:#CCD1D9;" d="M351.989,10.672c-46.123,0-87.677,19.515-116.871,50.733c-15.647-18.016-38.718-29.406-64.459-29.406 c-47.124,0-85.325,38.202-85.325,85.325c0,0.719,0.008,1.422,0.023,2.141C36.655,129.324,0,172.385,0,223.993 c0,58.904,47.757,106.668,106.661,106.668h245.328c88.356,0,159.995-71.638,159.995-159.995 C511.984,82.294,440.346,10.672,351.989,10.672z"></path> <path style="fill:#AAB2BC;" d="M453.954,47.358c22.922,27.687,36.703,63.217,36.703,101.966 c0,88.372-71.638,159.995-159.995,159.995H85.334c-24.016,0-46.179-7.937-64.006-21.327c19.46,25.905,50.443,42.67,85.333,42.67 h245.328c88.356,0,159.995-71.638,159.995-159.995C511.984,121.043,489.407,76.717,453.954,47.358z"></path> <path style="fill:#5D9CEC;" d="M85.326,501.312c-1.609,0-3.234-0.359-4.766-1.125c-5.266-2.625-7.406-9.047-4.773-14.313 l63.998-127.995c2.641-5.266,9.047-7.406,14.313-4.766c5.273,2.641,7.405,9.046,4.773,14.312L94.873,495.422 C93.006,499.156,89.232,501.312,85.326,501.312z"></path> <path style="fill:#4A89DC;" d="M149.324,501.312c-1.609,0-3.234-0.359-4.766-1.125c-5.266-2.625-7.406-9.047-4.773-14.313 l63.998-127.995c2.641-5.266,9.047-7.406,14.313-4.766c5.272,2.641,7.405,9.046,4.772,14.312l-63.997,127.997 C157.004,499.156,153.23,501.312,149.324,501.312z"></path> <path style="fill:#5D9CEC;" d="M213.322,501.312c-1.609,0-3.234-0.359-4.766-1.125c-5.266-2.625-7.406-9.047-4.773-14.313 l63.998-127.995c2.641-5.266,9.055-7.406,14.304-4.766c5.281,2.641,7.406,9.046,4.781,14.312l-63.998,127.997 C221.001,499.156,217.228,501.312,213.322,501.312z"></path> <path style="fill:#4A89DC;" d="M277.32,501.312c-1.609,0-3.234-0.359-4.766-1.125c-5.266-2.625-7.406-9.047-4.773-14.313 l64.006-127.995c2.625-5.266,9.03-7.406,14.312-4.766c5.266,2.641,7.406,9.046,4.766,14.312l-63.999,127.997 C284.991,499.156,281.225,501.312,277.32,501.312z"></path> </g></svg>
            <p>${ret.precipitation}%</p></div>`;
            if (/雨/.test(ret.weather)) {
              return "rainy";
            }
            switch (ret.weather) {
              case "陰有雷":
                return "cloudy";
              default:
                return "sunny";
            }
          })
          .then((weather) => {
            weatherBackgroundAnimation[weather]();
          });
      }
      const weatherBackgroundAnimation = {
        sunny: async function () {
          document.getElementById("weather").animate(
            [
              {
                backgroundColor: "#35374B",
              },
              {
                backgroundColor: "skyblue",
              },
            ],
            {
              duration: 1000,
            }
          );
          document.getElementById("sunny").style.display = "block";
          document.getElementById("sunny").animate(
            [
              {
                height: "0",
                opacity: "0",
              },
              {
                height: "30dvh",
                opacity: "1",
              },
            ],
            {
              duration: 1000,
            }
          );
          document.getElementById("weather").style.backgroundColor = "skyblue";
          document.getElementById("sunny").style.height = "30dvh";
        },
        cloudy: async function () {
          document.getElementById("weather").animate(
            [
              {
                backgroundColor: "#35374B",
              },
              {
                backgroundColor: "#ACC2D9",
              },
            ],
            {
              duration: 1000,
            }
          );
          document.getElementById("cloudy").style.display = "block";
          document.getElementById("weather").style.backgroundColor = "#ACC2D9";
          document.getElementById("cloudy").children[0].animate(
            [
              {
                left: "-5rem",
              },
              {
                left: "0",
              },
            ],
            {
              duration: 1000,
            }
          );
          document.getElementById("cloudy").children[1].animate(
            [
              {
                right: "-8rem",
              },
              {
                right: "0",
              },
            ],
            {
              duration: 1000,
            }
          );
        },
        rainy: async function () {
          let rainsArea = document.getElementById("rainy").children[2];
          let rains = [];
          let maximumRainsOnScreen = Math.floor(
            16 + Math.random() * (32 + 1 - 16)
          );
          let i = 0;
          while (i < maximumRainsOnScreen) {
            let left =
              Math.floor(20 + Math.random() * (100 + 1 - 20)).toString() + "%";
            rains[i] = document.createElement("div");
            rains[i].style.position = "absolute";
            rains[i].style.width = "1px";
            rains[i].style.height =
              Math.floor(10 + Math.random() * (30 + 1 - 10)).toString() + "px";
            rains[i].style.left = left;
            rains[i].style.top = "-60px";
            rains[i].style.backgroundColor = "white";
            rains[i].style.transform = "rotate(15deg)";
            rainsArea.append(rains[i]);
            rains[i].animate(
              [
                {
                  top: "-60px",
                  left: left,
                },
                {
                  top: "200px",
                  left: `calc(${left} - 70px)`,
                },
              ],
              {
                delay: Math.floor(100 + Math.random() * (900 + 1 - 100)),
                duration: 1000,
                iterations: Infinity,
              }
            );
            i++;
          }
          document.getElementById("weather").animate(
            [
              {
                backgroundColor: "#35374B",
              },
              {
                backgroundColor: "#6D7178",
              },
            ],
            {
              duration: 1000,
            }
          );
          document.getElementById("rainy").style.display = "block";
          document.getElementById("weather").style.backgroundColor = "#6D7178";
        },
      };
    </script>
  </body>
</html>
